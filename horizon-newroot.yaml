- hosts: controller

  tasks:
    - name: replace django urlpatterns to serve dashboard from new root
      copy:
        src: files/openstack/urls.py
        dest: /usr/share/openstack-dashboard/openstack_dashboard/
        backup: yes

    - name: update django environment to use new webroot
      lineinfile:
        path: /etc/openstack-dashboard/local_settings
        insertafter: "# END AUTOGENERATED SECTION   -- DO NOT REMOVE"
        line: 'WEBROOT="/openstack"'
        backup: yes

    - name: update nginx config to accept urls using new root
      replace:
         path: /etc/openstack-dashboard/dashboard-nginx.conf
         regexp: '{{ item.regexp }}'
         replace: '{{ item.replace }}'
         backup: yes
      with_items:
          - { regexp: "location /static", replace: "location ~ ^/openstack/(static.*)$" }
          - { regexp: "root /usr/share/openstack-dashboard/", replace: "alias /usr/share/openstack-dashboard/$1"}
          - { regexp: "location / {", replace: "location /openstack/ {" }

    - name: fix 404.html error page with new root
      replace:
        path: /usr/share/openstack-dashboard/openstack_dashboard/templates/404.html
        regexp: 'src="/static/dashboard'
        replace: 'src="/openstack/static/dashboard'
        backup: yes

    # address post reconfigure template updates
    # https://ask.openstack.org/en/question/52157/horizon-change-root-url/
    - name: update the offline manifest for template compression
      shell: python manage.py compress --force
      args:
        chdir:  /usr/share/openstack-dashboard
